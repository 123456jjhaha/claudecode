# Claude Agent System - 完整功能演示实例
#
# 本配置文件展示了系统的所有可用功能，包括：
# - 基础配置
# - 工具权限管理（重要：内置工具需要明确 disallowed 才能禁止）
# - 子实例配置
# - 会话记录系统
# - 高级配置选项

# ==================== 基础配置 ====================
agent:
  name: "demo_agent"
  description: "演示 Claude Agent System 所有功能的完整实例"

# 模型选择（可选项：claude-sonnet-4-5, claude-opus-4-5, claude-haiku-4）
model: "claude-sonnet-4-5"

# 系统提示词文件（相对于实例目录）
# 推荐使用 agent.md 以避免与 Claude Code 的 CLAUDE.md 冲突
system_prompt_file: ".claude/agent.md"

# ==================== 工具权限配置 ====================
#
# 重要说明：
# 1. 内置的 Claude 工具（如 Read, Write, Bash 等）默认全部允许
# 2. 要禁止某个内置工具，必须在 disallowed 中明确列出
# 3. allowed 列表主要用于限制 MCP 工具（自定义工具、外部 MCP、子实例）
# 4. 通配符 * 可以用于模式匹配

tools:
  # 明确禁止使用的内置工具（这些工具不会显示给 Claude）
  disallowed:
    - "WebFetch"      # 禁止网页获取
    - "WebSearch"     # 禁止网页搜索
    - "KillShell"     # 禁止杀死 shell 进程
    - "Task"          # 禁止启动新代理（可选）
    - "Skill"         # 禁止技能调用（可选）
    - "SlashCommand"  # 禁止斜杠命令（可选）

  # 允许的 MCP 工具（不包括内置工具）
  # 内置工具不需要在 allowed 中列出，它们默认就是允许的
  allowed:
    # 自定义工具（来自 tools/ 目录）
    - "mcp__custom_tools__calculator__*"
    - "mcp__custom_tools__file_analyzer__*"

    # 子实例工具（也注册在 custom_tools 服务器中）
    - "mcp__custom_tools__sub_claude_*"

# ==================== 子实例配置 ====================
#
# 子实例是独立的 Agent 实例，可以有自己的配置、工具和会话记录
sub_claude_instances:
  file_analyzer: "file_analyzer_agent"      # 文件分析子实例
  syntax_checker: "syntax_checker_agent"    # 语法检查子实例
# ==================== 会话记录配置 ====================
#
# 会话记录系统：消息在内存中收集，会话结束时一次性写入磁盘
# 设计原则：KISS（Keep It Simple, Stupid），避免过早优化
session_recording:
  # 基础开关
  enabled: true                    # 是否启用会话记录

  # 存储管理策略
  retention_days: 30               # 保留天数（超过此天数会被自动清理）
  max_total_size_mb: 1000          # 最大总大小（MB，超过会触发清理）
  auto_cleanup: true               # 是否自动清理过期会话

  # 消息过滤（精确控制记录哪些消息类型）
  # null 表示记录所有类型（推荐），包括 UserMessage, AssistantMessage,
  # ResultMessage, SystemMessage, StreamEvent
  message_types: null              # 记录所有消息类型

  # 或者只记录特定类型（不推荐，除非需要节省存储空间）：
  # message_types:
  #   - "UserMessage"       # 用户消息
  #   - "AssistantMessage"  # AI 助手消息（包含工具调用、思考过程等）
  #   - "ResultMessage"     # 结果消息（包含统计信息）
  #   - "SystemMessage"     # 系统消息
  #   - "StreamEvent"       # 流事件

  # 内容控制
  include_content: true            # 是否包含消息内容（设为 false 可节省空间）
  include_metadata: true           # 是否包含元数据（时间戳、序列号等）

# ==================== 高级配置 ====================
advanced:
  # 权限模式
  # permission_mode: "acceptEdits"    # 可选值：default, acceptEdits, plan, bypassPermissions
  permission_mode: "bypassPermissions"  # 改为这个，跳过权限检查
  # 执行限制
  max_turns: 100                    # 最大对话轮次

  # 配置源优先级
  setting_sources:
    - "project"                    # 项目级配置优先

  # 环境变量（传递给子进程）
  env:
    # ==================== SDK 超时配置 ====================
    #
    # 说明：这些环境变量用于控制 Claude SDK 的超时行为，避免子实例执行时崩溃
    #
    # 1. CLAUDE_CODE_STREAM_CLOSE_TIMEOUT:
    #    作用：控制 SDK 等待第一个结果的超时时间（毫秒）
    #    默认：60000ms (60秒)
    #    问题：如果子实例在 60 秒内没有返回第一个结果，SDK 会强制关闭流，导致子实例崩溃
    #    建议：设置为 300000ms (5分钟)，给子实例充足的执行时间
    #
    # 2. MCP_TIMEOUT:
    #    作用：MCP 服务器启动超时时间（毫秒）
    #    默认：30000ms (30秒)
    #    说明：启动子实例的 MCP 服务器时的等待时间
    #    建议：设置为 120000ms (2分钟)，给复杂的服务器更多启动时间
    #
    # 3. MCP_TOOL_TIMEOUT:
    #    作用：单个 MCP 工具执行超时时间（毫秒）
    #    默认：可能存在 bug，不一定生效
    #    说明：控制工具执行的超时时间
    #    建议：设置为 180000ms (3分钟)，作为额外的保障
    #
    CLAUDE_CODE_STREAM_CLOSE_TIMEOUT: "3000000"  # 5分钟 - 避免SDK强制关闭流
    MCP_TIMEOUT: "120000"                       # 2分钟 - MCP服务器启动超时
    MCP_TOOL_TIMEOUT: "1800000"                  # 3分钟 - MCP工具执行超时

    # 其他可选的环境变量配置
    # PYTHONPATH: "."
    # DEMO_MODE: "true"

  # 额外的目录访问权限（添加到工作目录）
  add_dirs:
    - "../shared_data"             # 允许访问共享数据目录
    - "./output"                   # 允许访问输出目录

# ==================== 工作空间配置 ====================
#
# 工作空间隔离系统：为每个 session 创建独立的工作目录
# 工作目录位置：instances/{name}/sessions/{session_id}/workspace/
workspace:
  # 目录管理
  auto_create: true               # 是否自动创建工作目录
  retention_days: 30              # 保留天数（用于手动清理工具参考）

  # System Prompt 注入
  init_message: true              # 是否在 system prompt 中告知工作目录
  # init_message_template: |      # 自定义消息模板（可选）
  #   ## Your Workspace
  #   Your dedicated workspace directory is: `{workspace_path}`
  #   - This is YOUR isolated workspace for this conversation
  #   - All files you create should go here
  #   - The workspace will be preserved for {retention_days} days

  # 工作目录大小限制（可选）
  max_size_mb: 500                # 单个工作目录最大大小（MB）
  warn_size_mb: 400               # 警告阈值（MB）

# ==================== 配置说明总结 ====================
#
# 1. 工具权限：
#    - 内置工具默认全部允许，需在 disallowed 中明确禁止
#    - MCP 工具需在 allowed 中明确允许
#    - 使用通配符 * 进行模式匹配
#
# 2. 子实例：
#    - 每个子实例都是完整的 AgentSystem
#    - 继承父实例的会话记录配置
#    - 可以有自己的配置覆盖
#
# 3. 会话记录：
#    - 内存收集 + 一次性写入，性能最优
#    - 支持消息类型过滤（推荐记录所有类型）
#    - 自动管理存储空间
#    - 生成调用关系图和统计信息
#
# 4. 高级选项：
#    - 权限模式控制文件访问策略
#    - 环境变量传递给所有子进程
#    - 可以添加额外的目录访问权限
#
# 5. 工作空间（强制启用）：
#    - 系统为每个 session 自动创建独立的工作目录
#    - 通过 system prompt 告知 Claude 工作目录位置
#    - 支持手动清理过期工作目录
#    - 工作目录固定路径：instances/{name}/sessions/{session_id}/workspace/